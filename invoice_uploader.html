<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Parser - Upload & Extract</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .header {
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            margin: 30px 0;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-zone.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-hint {
            color: #666;
            font-size: 1em;
        }

        #fileInput {
            display: none;
        }

        .file-list {
            margin: 20px 0;
            text-align: left;
        }

        .file-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9em;
        }

        .process-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-container {
            margin-top: 30px;
            text-align: left;
        }

        .results-header {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }

        .invoice-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .invoice-filename {
            font-weight: 700;
            color: #333;
            font-size: 1.1em;
        }

        .invoice-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .invoice-status.success {
            background: #d4edda;
            color: #155724;
        }

        .invoice-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .invoice-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .data-field {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .field-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .field-value {
            color: #333;
            font-weight: 500;
            font-size: 1em;
        }

        .performance-metrics {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .metric-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        .metric-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-weight: 700;
            color: #1976d2;
            font-size: 1.1em;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 0.85em;
            color: #6c757d;
        }

        .commodity-section {
            grid-column: 1 / -1; /* Span across all columns */
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
        }

        .commodity-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .commodity-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .commodity-item div {
            font-size: 0.9em;
            color: #333;
            margin-bottom: 5px;
        }

        .commodity-item div strong {
            color: #007bff;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .upload-zone {
                padding: 40px 15px;
            }
            
            .invoice-data {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Invoice Parser</h1>
            <p>Upload your PDF invoices and get structured data instantly</p>
        </div>

        <div class="upload-zone" id="uploadZone">
            <div class="upload-content">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Drop your PDF files here</div>
                <div class="upload-hint">or click to select multiple files (supports multiple selection)</div>
            </div>
        </div>

        <input type="file" id="fileInput" multiple accept=".pdf">

        <div class="file-list" id="fileList"></div>

        <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
            <button class="process-btn" id="processBtn" style="display: none;">
                Process Documents
            </button>
            <button class="clear-btn" id="clearBtn" style="display: none; background: #6c757d; color: white; border: none; border-radius: 8px; padding: 15px 30px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                Clear All
            </button>
        </div>

        <div class="status" id="status" style="display: none;"></div>
        
        <div class="progress-bar" id="progressContainer" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="results-container" id="resultsContainer" style="display: none;">
            <div class="results-header">üìä Extraction Results</div>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const clearBtn = document.getElementById('clearBtn');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const resultsContainer = document.getElementById('resultsContainer');
        const results = document.getElementById('results');

        let selectedFiles = [];

        // File upload handlers
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        processBtn.addEventListener('click', processFiles);
        clearBtn.addEventListener('click', clearAllFiles);

        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.type === 'application/pdf');
            if (files.length !== e.target.files.length) {
                showStatus('Only PDF files are allowed. Non-PDF files were filtered out.', 'error');
                setTimeout(() => status.style.display = 'none', 3000);
            }
            addFiles(files);
        }

        function addFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            updateFileList();
            updateProcessButton();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateProcessButton();
        }

        function updateProcessButton() {
            if (selectedFiles.length > 0) {
                processBtn.style.display = 'block';
                clearBtn.style.display = 'block';
                processBtn.textContent = `Process ${selectedFiles.length} Document${selectedFiles.length > 1 ? 's' : ''}`;
            } else {
                processBtn.style.display = 'none';
                clearBtn.style.display = 'none';
            }
        }

        function clearAllFiles() {
            selectedFiles = [];
            fileInput.value = '';
            updateFileList();
            updateProcessButton();
            resultsContainer.style.display = 'none';
            status.style.display = 'none';
            progressContainer.style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processFiles() {
            if (selectedFiles.length === 0) return;

            // Reset UI
            resultsContainer.style.display = 'none';
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            
            // Show processing status
            showStatus('Processing your documents... This may take a few moments.', 'processing');
            processBtn.disabled = true;

            // Simulate progress during upload
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 2;
                if (progress <= 90) {
                    progressFill.style.width = progress + '%';
                }
            }, 100);

            try {
                // Prepare form data
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                // Upload and process using our integrated endpoint
                const response = await fetch('/api/v2/upload-and-process-multiple-pdfs-integrated/', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Debug: Log the full response to see the structure
                console.log('=== FULL API RESPONSE ===');
                console.log('Response object:', result);
                console.log('Success:', result.success);
                console.log('Structured data:', result.structured_data);
                console.log('Processing results:', result.processing_results);
                if (result.structured_data) {
                    console.log('Invoices array:', result.structured_data.invoices);
                }
                if (result.processing_results) {
                    console.log('Successful processing:', result.processing_results.successful_processing);
                }
                console.log('========================');
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    displayResults(result);
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                showStatus(`Error: ${error.message}`, 'error');
                processBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function displayResults(result) {
            if (result.success) {
                showStatus(`‚úÖ Successfully processed ${result.summary.successful_processing} out of ${result.summary.total_files} documents!`, 'success');
                
                // Show performance metrics
                const performanceHtml = `
                    <div class="performance-metrics">
                        <h4>‚ö° Performance Metrics</h4>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">Total Time</div>
                                <div class="metric-value">${result.performance_metrics.total_time_seconds.toFixed(1)}s</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Upload Time</div>
                                <div class="metric-value">${result.performance_metrics.upload_time_seconds.toFixed(1)}s</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Processing Time</div>
                                <div class="metric-value">${result.performance_metrics.processing_time_seconds.toFixed(1)}s</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Success Rate</div>
                                <div class="metric-value">${result.summary.end_to_end_success_rate}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Display invoice results
                let invoicesHtml = performanceHtml;
                
                // Handle multiple possible response structures
                let invoicesToDisplay = [];
                
                // Try multiple possible paths for invoice data
                if (result.structured_data && result.structured_data.invoices && result.structured_data.invoices.length > 0) {
                    console.log('Found invoices in structured_data.invoices');
                    invoicesToDisplay = result.structured_data.invoices;
                } else if (result.processing_results && result.processing_results.successful_processing && result.processing_results.successful_processing.length > 0) {
                    console.log('Found invoices in processing_results.successful_processing');
                    invoicesToDisplay = result.processing_results.successful_processing;
                } else if (result.structured_data && Array.isArray(result.structured_data)) {
                    console.log('Found invoices as direct array in structured_data');
                    invoicesToDisplay = result.structured_data;
                } else {
                    console.log('No invoice data found in expected locations');
                    console.log('Available keys in result:', Object.keys(result));
                }
                
                if (invoicesToDisplay.length > 0) {
                    invoicesToDisplay.forEach((invoice, index) => {
                        console.log(`Processing invoice ${index + 1}:`, invoice);
                        
                        // Handle different data structures - be more flexible
                        const data = invoice.invoice_data || invoice.parsed_data || invoice.data || invoice || {};
                        const filename = invoice.filename || invoice.file_name || invoice.name || `Invoice ${index + 1}`;
                        
                        console.log(`Invoice ${index + 1} data:`, data);
                        console.log(`Invoice ${index + 1} filename:`, filename);
                        
                        // Create the invoice card with all possible fields
                        let dataFieldsHtml = '';
                        
                        // Extract all invoice sections
                        const invoiceMetadata = data.invoice_metadata || {};
                        const vendorInfo = data.vendor_information || {};
                        const customerInfo = data.customer_information || {};
                        const financialSummary = data.financial_summary || {};
                        const commodityDetails = data.commodity_details || {};
                        
                        // Check for all possible field names with proper data access
                        const fields = [
                            // Invoice Metadata
                            { key: 'invoice_number', label: 'Invoice Number', value: invoiceMetadata.invoice_number || data.invoice_number || data.invoice_no || data.number },
                            { key: 'invoice_date', label: 'Invoice Date', value: invoiceMetadata.invoice_date || data.invoice_date || data.date || data.issued_date },
                            { key: 'due_date', label: 'Due Date', value: invoiceMetadata.due_date || data.due_date || data.date_due },
                            { key: 'po_number', label: 'PO Number', value: invoiceMetadata.po_number || data.po_number || data.purchase_order },
                            { key: 'terms', label: 'Payment Terms', value: invoiceMetadata.terms || data.terms },
                            
                            // Vendor Information
                            { key: 'vendor_name', label: 'Vendor', value: vendorInfo.company_name || data.vendor_name || data.vendor || data.company_name },
                            { key: 'vendor_address', label: 'Vendor Address', value: vendorInfo.contact_info?.address || data.vendor_address || data.address },
                            { key: 'vendor_phone', label: 'Vendor Phone', value: vendorInfo.contact_info?.phone || data.vendor_phone },
                            { key: 'vendor_email', label: 'Vendor Email', value: vendorInfo.contact_info?.email || data.vendor_email },
                            
                            // Customer Information
                            { key: 'customer_name', label: 'Customer', value: customerInfo.company_name || data.customer_name || data.customer || data.bill_to },
                            { key: 'customer_address', label: 'Customer Address', value: customerInfo.contact_info?.address || data.customer_address },
                            { key: 'customer_phone', label: 'Customer Phone', value: customerInfo.contact_info?.phone || data.customer_phone },
                            { key: 'customer_email', label: 'Customer Email', value: customerInfo.contact_info?.email || data.customer_email },
                            
                            // Financial Summary
                            { key: 'subtotal', label: 'Subtotal', value: financialSummary.subtotal || data.subtotal || data.sub_total },
                            { key: 'tax_amount', label: 'Tax Amount', value: financialSummary.tax_amount || data.tax_amount || data.tax },
                            { key: 'tax_rate', label: 'Tax Rate', value: financialSummary.tax_rate || data.tax_rate },
                            { key: 'total_amount', label: 'Total Amount', value: financialSummary.total_amount || data.total_amount || data.total || data.amount },
                            { key: 'currency', label: 'Currency', value: financialSummary.currency || data.currency },
                            { key: 'payment_method', label: 'Payment Method', value: financialSummary.payment_method || data.payment_method }
                        ];
                        
                        fields.forEach(field => {
                            if (field.value) {
                                const displayValue = field.key.includes('amount') || field.key.includes('total') || field.key.includes('tax') || field.key.includes('subtotal')
                                    ? (field.value.toString().includes('$') ? field.value : `$${field.value}`)
                                    : field.value;
                                dataFieldsHtml += `<div class="data-field"><div class="field-label">${field.label}</div><div class="field-value">${displayValue}</div></div>`;
                            }
                        });
                        
                        // Add commodity details section if available
                        if (commodityDetails.items && commodityDetails.items.length > 0) {
                            dataFieldsHtml += `
                                <div class="data-field commodity-section" style="grid-column: 1 / -1; background: #f8f9fa; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-top: 15px;">
                                    <div class="field-label" style="color: #007bff; font-size: 1.1em; margin-bottom: 10px;">üì¶ Commodity Details</div>
                                    <div class="commodity-items">
                                        ${commodityDetails.items.map((item, index) => `
                                            <div class="commodity-item" style="background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                                <div style="font-weight: 600; color: #333; margin-bottom: 8px;">Item ${index + 1}</div>
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 0.9em;">
                                                    ${item.description ? `<div><strong>Description:</strong> ${item.description}</div>` : ''}
                                                    ${item.quantity ? `<div><strong>Quantity:</strong> ${item.quantity}</div>` : ''}
                                                    ${item.unit ? `<div><strong>Unit:</strong> ${item.unit}</div>` : ''}
                                                    ${item.unit_price ? `<div><strong>Unit Price:</strong> $${item.unit_price}</div>` : ''}
                                                    ${item.total_price ? `<div><strong>Total Price:</strong> $${item.total_price}</div>` : ''}
                                                    ${item.amount ? `<div><strong>Amount:</strong> $${item.amount}</div>` : ''}
                                                    ${item.item ? `<div><strong>Item Code:</strong> ${item.item}</div>` : ''}
                                                    ${item.category ? `<div><strong>Category:</strong> ${item.category}</div>` : ''}
                                                    ${item.line_number ? `<div><strong>Line #:</strong> ${item.line_number}</div>` : ''}
                                                    ${item.notes ? `<div><strong>Notes:</strong> ${item.notes}</div>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #666;">
                                        <strong>Total Items:</strong> ${commodityDetails.total_items || commodityDetails.items.length}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // If no fields found, show raw data for debugging
                        if (!dataFieldsHtml) {
                            dataFieldsHtml = `<div class="data-field"><div class="field-label">Raw Data</div><div class="field-value">${JSON.stringify(data, null, 2)}</div></div>`;
                        }
                        
                        invoicesHtml += `
                            <div class="invoice-card">
                                <div class="invoice-header">
                                    <div class="invoice-filename">${filename}</div>
                                    <div class="invoice-status success">‚úÖ Processed</div>
                                </div>
                                <div class="invoice-data">
                                    ${dataFieldsHtml}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    invoicesHtml += `
                        <div class="invoice-card">
                            <div style="text-align: center; color: #6c757d; padding: 20px;">
                                <h4>No Structured Invoice Data Found</h4>
                                <p>The files were processed but no structured data was extracted.</p>
                                <p><strong>Debugging Info:</strong></p>
                                <div style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                                    <p><strong>Response Keys:</strong> ${Object.keys(result).join(', ')}</p>
                                    ${result.structured_data ? `<p><strong>Structured Data Keys:</strong> ${Object.keys(result.structured_data).join(', ')}</p>` : ''}
                                    ${result.processing_results ? `<p><strong>Processing Results Keys:</strong> ${Object.keys(result.processing_results).join(', ')}</p>` : ''}
                                </div>
                                <p style="margin-top: 10px;"><em>Check browser console (F12) for detailed response data.</em></p>
                            </div>
                        </div>
                    `;
                }

                // Display failed processing if any
                if (result.processing_results.failed_processing.length > 0) {
                    result.processing_results.failed_processing.forEach(failed => {
                        invoicesHtml += `
                            <div class="invoice-card">
                                <div class="invoice-header">
                                    <div class="invoice-filename">${failed.filename}</div>
                                    <div class="invoice-status error">‚ùå Failed</div>
                                </div>
                                <div style="color: #721c24; margin-top: 10px;">
                                    Error: ${failed.processing_error || 'Processing failed'}
                                </div>
                            </div>
                        `;
                    });
                }

                results.innerHTML = invoicesHtml;
                resultsContainer.style.display = 'block';
            } else {
                showStatus(`‚ùå Processing failed: ${result.message}`, 'error');
            }

            // Reset for next upload
            selectedFiles = [];
            updateFileList();
            updateProcessButton();
            processBtn.disabled = false;
            // Don't reset fileInput.value here - let user add more files if needed
        }
    </script>
</body>
</html> 